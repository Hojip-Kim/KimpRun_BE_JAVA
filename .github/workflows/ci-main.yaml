# ë©”ì¸ ë¸Œëžœì¹˜(ê°œë°œìš© ì„œë²„ ë°°í¬)ì— í‘¸ì‹œë˜ë©´ ì‹¤í–‰ë˜ëŠ” ì›Œí¬í”Œë¡œìš°
name: CI-main

on: push

jobs:
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          path: ./kimprun_be
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: gradle
      # AWS ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_S3_REGION }}
      - name: Download application-dev.yml
        run: |
          aws s3 cp ${{ secrets.AWS_S3_BE_YAML }} ./kimprun_be/src/main/resources/application-dev.yml
          mkdir -p ./kimprun_be/src/test/resources
          cp ./kimprun_be/src/main/resources/application-dev.yml ./kimprun_be/src/test/resources/application-dev.yml
      # ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission
        run: chmod +x ./kimprun_be/gradlew
      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run unit test
        run: ./gradlew test
        working-directory: ./kimprun_be
      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ë‹¨ìœ„í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ)
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure() && steps.run-unit-test.outcome == 'failure'
        with:
          name: test-results
          path: ./kimprun_be/build/test-results
  # í†µí•© í…ŒìŠ¤íŠ¸
  integration-test:
    # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì‹¤í–‰
    needs: unit-test
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          path: ./kimprun_be
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: gradle
      # ë„ì»¤ ì„¤ì •
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      # AWS ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_S3_REGION }}

      - name: Download application-dev.yml
        run: |
          aws s3 cp ${{ secrets.AWS_S3_BE_YAML }} ./kimprun_be/src/main/resources/application-dev.yml
          mkdir -p ./kimprun_be/src/test/resources
          cp ./kimprun_be/src/main/resources/application-dev.yml ./kimprun_be/src/test/resources/application-dev.yml

      - name: Download env file from S3
        run: |
          mkdir -p ./kimprun_fe
          aws s3 cp ${{ secrets.AWS_S3_FE_ENV }} ./kimprun_fe/.env.test

      - name: Update compose.yaml fe env file path
        run: |
          sed -i 's|ENV_FILE_DIR|../kimprun_fe/.env.test|' ./kimprun_be/compose.yaml

      # ë™ì ìœ¼ë¡œ ìµœì‹  FE ì´ë¯¸ì§€ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
      - name: Get latest FE image tag
        run: |
          echo "ðŸ” Fetching latest FE image tag from Docker Hub..."
          
          # Docker Hub APIë¡œ ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (ê°€ìž¥ ìµœê·¼ì— í‘¸ì‹œëœ ìˆœì„œ)
          LATEST_TAG=$(curl -s "https://registry.hub.docker.com/v2/repositories/hojipkim/kimprun_fe/tags/?page_size=1&ordering=-last_updated" \
            | jq -r '.results[0].name // "latest"')
          
          echo "ðŸ“¦ Latest available tag: $LATEST_TAG"
          
          # ë§Œì•½ API í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ê±°ë‚˜ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ëŒ€ì²´ ë°©ë²• ì‚¬ìš©
          if [ "$LATEST_TAG" = "null" ] || [ -z "$LATEST_TAG" ]; then
            echo "âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‚¬ìš©..."
            # ì—¬ëŸ¬ ê°€ëŠ¥í•œ íƒœê·¸ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì‹œë„
            POSSIBLE_TAGS=("latest" "d7be19" "c1073f" "77f3f9")
          
            for TAG in "${POSSIBLE_TAGS[@]}"; do
              echo "ðŸ” Checking tag: $TAG"
              if docker manifest inspect "hojipkim/kimprun_fe:$TAG" > /dev/null 2>&1; then
                LATEST_TAG="$TAG"
                echo "âœ… Found working tag: $TAG"
                break
              fi
            done
          fi
          
          # í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
          echo "FE_IMAGE_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "ðŸŽ¯ Using FE image tag: $LATEST_TAG"

      # FE ì´ë¯¸ì§€ íƒœê·¸ ê²€ì¦ ë° ëŒ€ì²´
      - name: Verify and configure FE image
        run: |
          FE_IMAGE="hojipkim/kimprun_fe:${{ env.FE_IMAGE_TAG }}"
          echo "ðŸ” Verifying FE image: $FE_IMAGE"
          
          # ì´ë¯¸ì§€ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
          if docker manifest inspect "$FE_IMAGE" > /dev/null 2>&1; then
            echo "âœ… FE image verified successfully: $FE_IMAGE"
            sed -i "s|fe_image|$FE_IMAGE|g" ./kimprun_be/compose.yaml
          else
            echo "âŒ FE image not accessible: $FE_IMAGE"
            echo "ðŸ”„ Using nginx fallback for integration tests"
            sed -i 's|fe_image|nginx:alpine|g' ./kimprun_be/compose.yaml
          
            # nginx ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ í¬íŠ¸ ì¡°ì • (í•„ìš”í•œ ê²½ìš°)
            # sed -i 's|3000:3000|80:80|g' ./kimprun_be/compose.yaml
          fi

      # ë””ë²„ê¹…ì„ ìœ„í•œ compose.yaml ë‚´ìš© ì¶œë ¥
      - name: Debug - Show final compose.yaml
        run: |
          echo "=== ðŸ“‹ Final compose.yaml content ==="
          cat ./kimprun_be/compose.yaml
          echo "=================================="

      # ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission
        run: chmod +x ./kimprun_be/gradlew
      # ë„ì»¤ ë¹Œë“œ ì„¤ì • - í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ í†µí•´ í†µí•©í…ŒìŠ¤íŠ¸ í™˜ê²½(ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜ì¡´ì„± í™˜ê²½) êµ¬ì¶•
      - name: Set up Docker compose
        uses: docker/setup-buildx-action@v3

      # í†µí•© í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•
      - name: Start dependencies with Docker compose
        run: |
          echo "ðŸš€ Starting Docker Compose services..."
          docker compose up -d
          echo "ðŸ“Š Checking service status..."
          docker compose ps
        working-directory: ./kimprun_be

      # í†µí•© í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶• í›„ 30ì´ˆ ëŒ€ê¸° - ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œê°„
      - name: Wait for dependencies to start
        run: |
          echo "â³ Waiting for services to be ready..."
          sleep 30
          echo "ðŸ“‹ Final service status:"
          docker compose ps
        working-directory: ./kimprun_be

      # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run integration test
        run: ./gradlew integrationTest
        working-directory: ./kimprun_be
      # í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ í†µí•© í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¢…ë£Œ
      - name: Stop dependencies
        if: always()
        run: |
          echo "ðŸ›‘ Stopping Docker Compose services..."
          docker compose down
          echo "ðŸ§¹ Cleaning up..."
          docker compose ps
        working-directory: ./kimprun_be
      # í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (í†µí•©í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ)
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: failure() && steps.run-integration-test.outcome == 'failure'
        with:
          name: integration-test-results
          path: ./kimprun_be/build/test-results
  
  # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë˜ëŠ”ì§€ í™•ì¸
  # ì»¤ë°‹ì•„ì´ë”” 6ìžë¡œ ì¤„ì¸ ê°’ output ì œê³µ (ë„ì»¤ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©)
  build-verifaication:
    needs: integration-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate commit ID
        shell: bash
        run: |
          echo "COMMIT_ID=${GITHUB_SHA::6}" >> "$GITHUB_ENV"
          echo "${GITHUB_SHA::6}" > commit-id.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image - verification
        run: docker build --platform linux/amd64 -t hojipkim/kimprun_be:${{ env.COMMIT_ID }} .

      - name: Upload commit ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: commit-id
          path: commit-id.txt
          retention-days: 1
    outputs:
      commit_id: ${{ env.COMMIT_ID }}