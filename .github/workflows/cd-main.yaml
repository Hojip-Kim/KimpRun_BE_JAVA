#  Í∞úÎ∞ú ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨
name: CD-main

on:
  workflow_run:
    workflows:
      - 'CI-main'
    types:
      - completed
    branches:
      - 'main'

jobs:
  build-and-push:
    # CI ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÑ±Í≥µÌñàÏùÑ Ïãú Ïã§Ìñâ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      # Ïª§Î∞ã ÏïÑÏù¥Îîî ÏùΩÍ∏∞
      - name: Download commit ID artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-main
          run_id: ${{ github.event.workflow_run.id }}
          name: commit-id
          path: .

      - name: Read commit ID
        id: read-commit-id
        run: |
          COMMIT_ID=$(cat commit-id.txt)
          echo "COMMIT_ID=${COMMIT_ID}" >> $GITHUB_ENV
          echo "Commit ID : ${COMMIT_ID}"

      - name: Checkout Source code
        uses: actions/checkout@v4
        with:
          path: ./kimprun_be

      - name: Login to Docker Hub
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        run : |
          docker build --platform linux/amd64 -t hojipkim/kimprun_be:${{ env.COMMIT_ID }} .
          docker push hojipkim/kimprun_be:${{ env.COMMIT_ID }}
          echo " Docker image pushed: hojipkim/kimprun_be:${{ env.COMMIT_ID }}"
    outputs:
      commit-id: ${{ env.COMMIT_ID }}

  chart-update:
    needs: build-and-push
    runs-on: self-hosted
    steps:
      - name: Read commit ID from previous job
        run: |
          echo "COMMIT_ID=${{ needs.build-and-push.outputs.commit-id }}" >> $GITHUB_ENV
          echo "Commit ID : ${needs.build-and-push.outputs.commit-id}"

      - name: Checkout charts repository
        uses: actions/checkout@v4
        with:
          repository: Hojip-Kim/Kimprun_HelmCharts
          ref: main
          token: ${{ secrets.CHARTS_REPO_PAT }}

      - name: Update backend image tag in values.yaml
        shell: bash
        run: |
          echo "Ïª§Î∞ã ÏïÑÏù¥Îîî : $COMMIT_ID"
          yq -i '.backend.image.tag = "'${COMMIT_ID}'"' values.yaml
          cat values.yaml | grep -A 3 "backend:"

      - name: Commit and push changes to charts repository
        run: |
          git add values.yaml
          git commit -m "Update backend image tag to $COMMIT_ID"
          git push origin main

      - name: Deploy with ArgoCD CLI (Port Forwarding)
        run: |
          echo "üöÄ Starting deployment with ArgoCD CLI..."
          
          kubectl port-forward svc/argocd-server -n argocd 8080:443 &
          PORT_FORWARD_PID=$!
          
          echo "‚è≥ Waiting for port-forward to be ready..."
          sleep 10
          
          argocd login localhost:8080 \
            --username admin \
            --password UonNFTEzFUJUdPsB \
            --insecure
      
          echo "‚úÖ ArgoCD login successful!"
          
          argocd app sync kimprun-app --insecure
          
          echo "‚úÖ Deployment completed successfully!"
          
          kill $PORT_FORWARD_PID || true

      - name: Clean up workspace
        if: always()
        run: |
          rm -rf $GITHUB_WORKSPACE/*
